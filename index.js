const { Client, GatewayIntentBits } = require('discord.js');
const fs = require('fs');

const config = JSON.parse(fs.readFileSync('config.json', 'utf8'));

const client = new Client({ intents: [GatewayIntentBits.Guilds, GatewayIntentBits.GuildMembers] });

client.once('ready', async () => {
    console.log('Le bot est en ligne!');

    const chalk = (await import('chalk')).default;

    const guild = await client.guilds.fetch(config.guildId);

    const members = await guild.members.fetch();

    const dmMessageTemplate = config.dmMessage;

    const memberQueue = Array.from(members.values()).filter(member => !member.user.bot);

    const sendDM = async (member) => {
        try {
            const dmMessage = dmMessageTemplate.replace(/{user}/g, `<@${member.id}>`);
            const dmChannel = await member.createDM();
            await dmChannel.send(dmMessage);
            console.log(chalk.green(`Message DM envoyé à ${member.user.tag}`));
        } catch (error) {
            console.error(chalk.red(`Erreur lors de l'envoi du message DM à ${member.user.tag}: ${error}`));
        }
    };

    const sendDMsInParallel = async (members, chunkSize) => {
        let index = 0;
        while (index < members.length) {
            const chunk = members.slice(index, index + chunkSize);
            await Promise.all(chunk.map(sendDM));
            index += chunkSize;
            await new Promise(resolve => setTimeout(resolve, 0));
        }
    };
    
    await sendDMsInParallel(memberQueue, 100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000);

    console.log(chalk.blue('Tous les messages DM ont été envoyés.'));
});

client.on('error', async error => {
    const chalk = (await import('chalk')).default;
    console.error(chalk.red(`Erreur du client: ${error}`));
});

client.login(config.token)
    .then(async () => {
        const chalk = (await import('chalk')).default;
        console.log(chalk.blue('Connexion réussie!'));
    })
    .catch(async error => {
        const chalk = (await import('chalk')).default;
        console.error(chalk.red(`Erreur de connexion: ${error}`));
    });
